<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASV ➔ Threema: Schul-Konverter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #020617; 
            margin: 0;
            color: #f8fafc;
        }

        .glow-card {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(51, 65, 85, 0.5);
        }

        /* PRINT SETTINGS - Streng S/W, Exakt 2 Seiten */
        @media print {
            @page { 
                size: A4 portrait; 
                margin: 0; 
            }
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; padding: 0 !important; margin: 0 !important; }
            
            .print-container { display: block !important; }
            
            .letter-page { 
                width: 210mm; 
                height: 296.5mm; 
                padding: 15mm 25mm; 
                margin: 0 !important; 
                page-break-after: always; 
                box-sizing: border-box;
                border: none !important;
                display: flex !important;
                flex-direction: column;
                background: white !important;
                color: black !important;
                position: relative;
                overflow: hidden;
            }
            
            .letter-page * { 
                border-color: black !important; 
                color: black !important; 
                background: transparent !important; 
            }
        }

        /* Shared Letter Styles for Printing */
        .letter-content { font-size: 10.5pt; line-height: 1.4; }
        .header-table { width: 100%; border-bottom: 2px solid black; padding-bottom: 3mm; margin-bottom: 5mm; }
        .logo-placeholder { border: 2.5px solid black; font-weight: 900; font-size: 9pt; text-align: center; width: 110px; height: 50px; display: flex; align-items: center; justify-content: center; text-transform: uppercase; line-height: 1; }
        
        .cred-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .cred-table td { padding: 6px 0; border-bottom: 1px solid #eee; }
        .cred-label { font-weight: 700; width: 180px; }
        
        .qr-wrap { display: flex; justify-content: space-around; margin: 15px 0; text-align: center; }
        .qr-wrap canvas, .qr-wrap img { width: 110px; height: 110px; border: 1px solid black; padding: 4px; }

        .safe-box { border: 3px solid black; padding: 15px; margin-top: 10px; background: #f9f9f9; }
        .input-line { border-bottom: 2px solid black; height: 28px; margin-top: 4px; width: 90%; }

        .tab-btn { transition: all 0.3s ease; }
        .tab-btn.active { background: #059669; color: white; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.4); }

        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            padding-top: 0.5rem;
            min-width: 280px;
            z-index: 100;
        }
        .group:hover .dropdown-menu { display: block; }

        /* Modal Styling */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal-content {
            background: #1e293b;
            border: 1px solid #334155;
            max-width: 440px;
            width: 100%;
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-10">

    <div class="max-w-6xl mx-auto no-print">
        <header class="mb-12 flex flex-col lg:flex-row justify-between items-center gap-8">
            <div class="flex items-center gap-6">
                <div class="bg-emerald-600 p-4 rounded-3xl shadow-2xl shadow-emerald-900/40">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                </div>
                <div>
                    <h1 class="text-3xl font-black text-white tracking-tight">ASV ➔ Threema Work</h1>
                    <div class="flex items-center gap-3 mt-2">
                        <span class="text-emerald-400 font-bold text-[11px] uppercase tracking-widest">GMS Goldberg Edition v12.4</span>
                        <div class="h-1.5 w-1.5 bg-slate-700 rounded-full"></div>
                        <span id="currentModeLabel" class="text-slate-500 font-bold text-[11px] uppercase tracking-widest">Modus: Schüler</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-2 bg-slate-900/80 p-1.5 rounded-2xl border border-slate-800">
                <button onclick="switchMode('student')" id="tabStudent" class="tab-btn active px-6 py-2.5 rounded-xl text-xs font-bold text-slate-400 hover:text-white transition-all">Schüler (ASV)</button>
                <button onclick="switchMode('teacher')" id="tabTeacher" class="tab-btn px-6 py-2.5 rounded-xl text-xs font-bold text-slate-400 hover:text-white transition-all">Lehrer (Manuell)</button>
            </div>
            
            <div id="actionButtons" class="hidden flex items-center gap-3">
                <div class="relative group">
                    <button class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-xl font-bold flex items-center transition-all shadow-xl shadow-indigo-900/30">
                        Export & Druck
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="dropdown-menu">
                        <div id="exportMenuContent" class="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden ring-1 ring-black/5"></div>
                    </div>
                </div>
                <button onclick="showChangeModal('reset')" class="bg-slate-800 hover:bg-slate-700 text-slate-300 px-6 py-3 rounded-xl font-bold border border-slate-700 transition-all">Neu starten</button>
            </div>
        </header>

        <!-- Upload Bereich -->
        <div id="studentInputArea" class="block">
            <div id="dropZone" class="glow-card rounded-[3rem] p-20 text-center cursor-pointer border-2 border-dashed border-slate-700 hover:border-emerald-500/50 transition-all group">
                <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls, .csv">
                <div class="flex flex-col items-center">
                    <div class="w-20 h-20 bg-slate-800 rounded-3xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                        <svg class="w-10 h-10 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    </div>
                    <p class="text-2xl font-bold text-white mb-2">Excel-Datei laden</p>
                    <p class="text-slate-500 text-sm">Klicken oder ASV-Export hierher ziehen</p>
                </div>
            </div>
        </div>

        <!-- Lehrer Bereich -->
        <div id="teacherInputArea" class="hidden">
            <div class="glow-card rounded-3xl p-10 border border-slate-800 shadow-2xl">
                <h2 class="text-xl font-bold text-white mb-8">Lehrkraft manuell hinzufügen</h2>
                <form onsubmit="event.preventDefault(); addManualTeacher();" class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                    <input type="text" id="teacherVN" placeholder="Vorname" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-5 py-3.5 text-white focus:border-indigo-500 outline-none transition-all">
                    <input type="text" id="teacherNN" placeholder="Nachname" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-5 py-3.5 text-white focus:border-indigo-500 outline-none transition-all">
                    <div class="md:col-span-2 flex justify-end">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold px-8 py-3.5 rounded-xl transition-all">Hinzufügen</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Vorschau & Liste -->
        <div id="previewContainer" class="hidden mt-12 space-y-10">
            <div id="classButtonsContainer" class="glow-card rounded-3xl p-8 border-l-[6px] border-l-indigo-600">
                <h3 class="text-[11px] font-black text-slate-500 uppercase tracking-widest mb-6">Einzeldruck nach Klassen</h3>
                <div id="classButtons" class="flex flex-wrap gap-3"></div>
            </div>

            <!-- Tabelle -->
            <div class="glow-card rounded-3xl border border-slate-800 overflow-hidden shadow-2xl">
                <div class="px-8 py-5 bg-slate-900/50 flex justify-between items-center border-b border-slate-800">
                    <h3 class="font-bold text-white">Datenvorschau (<span id="countLabel">0</span>)</h3>
                </div>
                <div class="overflow-x-auto max-h-[600px]">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-950 text-slate-500 uppercase sticky top-0 z-20">
                            <tr>
                                <th class="px-6 py-4 text-center font-black">#</th>
                                <th class="px-8 py-4 font-black">User</th>
                                <th class="px-8 py-4 font-black">Name</th>
                                <th class="px-8 py-4 font-black" id="thKlasse">Klasse</th>
                                <th class="px-6 py-4 no-print text-center">Aktion</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-slate-800/60 text-slate-300"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Sicherheits-Modal -->
    <div id="changeModal" class="modal-overlay">
        <div class="modal-content">
            <div class="w-16 h-16 bg-red-500/10 rounded-2xl flex items-center justify-center mb-6">
                <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            </div>
            <h3 class="text-2xl font-bold text-white mb-3">Daten verwerfen?</h3>
            <p id="modalText" class="text-slate-400 text-sm mb-10 leading-relaxed">Alle aktuell geladenen Daten und Passwörter gehen verloren. Fortfahren?</p>
            <div class="flex gap-4">
                <button id="confirmBtn" class="flex-1 bg-red-600 hover:bg-red-500 text-white font-bold py-3.5 rounded-2xl transition-all shadow-lg">Ja, löschen</button>
                <button onclick="closeModal()" class="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-200 font-bold py-3.5 rounded-2xl transition-all">Abbrechen</button>
            </div>
        </div>
    </div>

    <div id="printArea" class="hidden print-container"></div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const previewContainer = document.getElementById('previewContainer');
        const actionButtons = document.getElementById('actionButtons');
        const printArea = document.getElementById('printArea');
        const classButtonsContainer = document.getElementById('classButtons');
        const tableBody = document.getElementById('tableBody');
        const countLabel = document.getElementById('countLabel');
        const exportMenuContent = document.getElementById('exportMenuContent');
        const studentInputArea = document.getElementById('studentInputArea');
        const teacherInputArea = document.getElementById('teacherInputArea');
        const tabStudent = document.getElementById('tabStudent');
        const tabTeacher = document.getElementById('tabTeacher');
        const changeModal = document.getElementById('changeModal');

        let students = [];
        let classesMap = {};
        let appMode = 'student'; 
        let usedUsernames = new Set();
        const CHUNK_SIZE = 80;

        // Warnung vor dem Schließen/Aktualisieren (F5 Schutz)
        window.addEventListener('beforeunload', (e) => {
            if (students.length > 0) {
                e.preventDefault();
                e.returnValue = ''; // Standard für moderne Browser
            }
        });

        // UI Handlers
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => e.target.files.length > 0 && handleFile(e.target.files[0]);
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('active'); };
        dropZone.ondragleave = () => dropZone.classList.remove('active');
        dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('active'); handleFile(e.dataTransfer.files[0]); };

        function switchMode(newMode) {
            if (appMode === newMode) return; // Schutz: Nichts tun wenn man auf den aktiven Tab klickt
            
            if (students.length > 0) {
                showChangeModal('switch', newMode);
            } else {
                executeSwitch(newMode);
            }
        }

        function executeSwitch(newMode) {
            appMode = newMode;
            students = [];
            usedUsernames = new Set();
            classesMap = {};
            tabStudent.classList.toggle('active', newMode === 'student');
            tabTeacher.classList.toggle('active', newMode === 'teacher');
            studentInputArea.classList.toggle('hidden', newMode !== 'student');
            teacherInputArea.classList.toggle('hidden', newMode !== 'teacher');
            previewContainer.classList.add('hidden');
            actionButtons.classList.add('hidden');
            tableBody.innerHTML = "";
            countLabel.innerText = "0";
            fileInput.value = "";
            document.getElementById('thKlasse').innerText = newMode === 'student' ? 'Klasse' : 'Rolle';
        }

        function showChangeModal(type, targetMode = null) {
            changeModal.style.display = 'flex';
            const modalText = document.getElementById('modalText');
            
            if (type === 'reset') {
                modalText.innerText = "Die Liste wird geleert und alle Daten gehen verloren. Möchten Sie neu starten?";
            } else {
                modalText.innerText = "Beim Wechsel des Modus werden alle aktuellen Daten gelöscht. Fortfahren?";
            }

            document.getElementById('confirmBtn').onclick = () => {
                closeModal();
                if (type === 'reset') location.reload();
                if (type === 'switch') executeSwitch(targetMode);
            };
        }

        function closeModal() {
            changeModal.style.display = 'none';
        }

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
                    processData(data);
                } catch (err) { alert("Fehler beim Lesen der Excel-Datei."); }
            };
            reader.readAsArrayBuffer(file);
        }

        function processData(data) {
            let idxVN = -1, idxNN = -1, idxKL = -1, headerIdx = -1;
            
            for (let i = 0; i < Math.min(data.length, 20); i++) {
                const row = data[i].map(c => String(c || "").toLowerCase().trim());
                idxVN = row.findIndex(x => ["vornamen", "vorname", "rufname"].some(k => x.includes(k)));
                idxNN = row.findIndex(x => ["familienname", "nachname", "name"].some(k => x.includes(k)));
                idxKL = row.findIndex(x => ["klasse", "kl", "abteilung"].some(k => x.includes(k)));
                if (idxVN !== -1 && idxNN !== -1) { headerIdx = i; break; }
            }

            if (headerIdx === -1) return alert("Spalten 'Vorname' und 'Nachname' nicht gefunden.");

            students = []; usedUsernames = new Set();
            for (let i = headerIdx + 1; i < data.length; i++) {
                const vn = String(data[i][idxVN] || "").trim();
                const nn = String(data[i][idxNN] || "").trim();
                const kl = idxKL !== -1 ? String(data[i][idxKL] || "").trim() : "";
                if (vn && nn) students.push(createPerson(vn, nn, kl));
            }
            updateUI();
        }

        function addManualTeacher() {
            const vn = document.getElementById('teacherVN').value.trim();
            const nn = document.getElementById('teacherNN').value.trim();
            if (vn && nn) {
                students.push(createPerson(vn, nn, ""));
                updateUI();
                document.getElementById('teacherVN').value = "";
                document.getElementById('teacherNN').value = "";
            }
        }

        function createPerson(vn, nn, kl) {
            let base = `${vn.substring(0,3).toLowerCase().replace(/\s/g, '')}.${nn.toLowerCase().replace(/\s+/g, '')}`;
            let user = base;
            let c = 1;
            while(usedUsernames.has(user)) { user = base + c; c++; }
            usedUsernames.add(user);

            let pass = "";
            const abc = "abcdefghijkmnpqrstuvwxyz"; 
            const num = "123456789";
            for(let j=0; j<10; j++) {
                if (Math.random() < 0.35) pass += num.charAt(Math.floor(Math.random() * 9));
                else pass += abc.charAt(Math.floor(Math.random() * 24));
            }

            return { vn, nn, kl, user, pass, id: `p-${Date.now()}-${Math.random()}`, type: appMode };
        }

        function updateUI() {
            tableBody.innerHTML = "";
            classesMap = {};
            students.forEach((s, idx) => {
                if (s.kl) { if (!classesMap[s.kl]) classesMap[s.kl] = []; classesMap[s.kl].push(s); }
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-800/30 transition-colors";
                tr.innerHTML = `<td class="px-6 py-3 text-center text-slate-500 font-mono text-xs">${idx + 1}</td><td class="px-8 py-3 font-bold text-emerald-400 font-mono">${s.user}</td><td class="px-8 py-3 text-white font-medium">${s.vn} ${s.nn}</td><td class="px-8 py-3 text-slate-500">${s.type==='student' ? (s.kl || '-') : 'Lehrkraft'}</td><td class="px-6 py-3 no-print text-center"><button onclick="removePerson(${idx})" class="text-slate-600 hover:text-red-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></td>`;
                tableBody.appendChild(tr);
            });

            // Buttons
            const btnWrap = document.getElementById('classButtons');
            btnWrap.innerHTML = "";
            if (appMode === 'student') {
                Object.keys(classesMap).sort().forEach(kl => {
                    const btn = document.createElement('button');
                    btn.className = "bg-slate-800 hover:bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold border border-slate-700 transition-all";
                    btn.innerHTML = kl;
                    btn.onclick = () => printClass(kl);
                    btnWrap.appendChild(btn);
                });
            }

            // Export Menu
            exportMenuContent.innerHTML = `<button onclick="printAll()" class="w-full text-left px-6 py-4 text-sm font-bold hover:bg-indigo-600/10 text-indigo-100 border-b border-slate-700/50">Alle Briefe drucken</button>`;
            for (let i = 0; i < students.length; i += CHUNK_SIZE) {
                const end = Math.min(i + CHUNK_SIZE, students.length);
                const btn = document.createElement('button');
                btn.className = "w-full text-left px-6 py-4 text-sm hover:bg-emerald-600/10 text-emerald-100 border-b border-slate-700/50 last:border-0";
                btn.innerText = `CSV Teil ${Math.floor(i/CHUNK_SIZE)+1} (${i+1}-${end})`;
                btn.onclick = () => downloadCSV(i, end);
                exportMenuContent.appendChild(btn);
            }

            countLabel.innerText = students.length;
            previewContainer.classList.toggle('hidden', students.length === 0);
            actionButtons.classList.toggle('hidden', students.length === 0);
            if (appMode === 'student' && students.length > 0) studentInputArea.classList.add('hidden');
        }

        function generateLetterHTML(s) {
            const isT = s.type === 'teacher';
            return `
                <div class="letter-page">
                    <table class="header-table">
                        <tr>
                            <td style="font-size: 8.5pt; line-height: 1.4;">
                                <strong style="font-size: 10.5pt;">GEMEINSCHAFTSSCHULE GOLDBERG</strong><br>
                                Goldbergstraße 34, 71065 Sindelfingen<br>
                                <span style="font-weight: 600;">Tel.:</span> 07031-4103190 | <span style="font-weight: 600;">E-Mail:</span> poststelle@04121769.schule.bwl.de
                            </td>
                            <td align="right" valign="top">
                                <div class="logo-box">
                                    <img src="logo.png" style="max-height: 50px;" onerror="this.outerHTML='<div class=\'logo-placeholder\'>GMS<br>GOLDBERG</div>'">
                                </div>
                            </td>
                        </tr>
                    </table>
                    <p style="margin-top: 3mm; font-weight: 600; font-size: 11pt;">Liebe/r ${isT ? 'Mitarbeitende/r' : 'Lernende/r'},</p>
                    <p style="margin-top: 2mm;">für deine schulische Kommunikation erhältst du hiermit Zugriff auf <strong>Threema Work</strong>.</p>
                    <div style="border: 2.5px solid black; padding: 12px; margin: 10px 0; background: #fcfcfc;">
                        <table class="cred-table">
                            <tr><td class="cred-label">Vorname:</td><td>${s.vn}</td></tr>
                            <tr><td class="cred-label">Nachname:</td><td>${s.nn}</td></tr>
                            ${isT ? '' : `<tr><td class="cred-label">Klasse:</td><td>${s.kl}</td></tr>`}
                            <tr style="border-top: 2px solid black;"><td class="cred-label">Benutzername:</td><td><strong>${s.user}</strong></td></tr>
                            <tr><td class="cred-label">Passwort:</td><td><strong>${s.pass}</strong></td></tr>
                        </table>
                    </div>
                    <p style="text-align: center; font-size: 9pt; margin-top: 5mm;"><strong>INSTALLATION DER APP:</strong></p>
                    <div class="qr-wrap">
                        <div><canvas id="qr-and-${s.id}"></canvas><br><small><strong>Android</strong></small></div>
                        <div><canvas id="qr-ios-${s.id}"></canvas><br><small><strong>iOS (iPhone)</strong></small></div>
                    </div>
                    <div style="margin-top: auto; font-size: 8pt; color: #666; border-top: 1px solid #eee; padding-top: 2mm;">
                        Hinweis: Diese Zugangsdaten sind vertraulich. Bitte melde dich bei Erhalt sofort an.
                    </div>
                </div>
                <div class="letter-page">
                    <table class="header-table">
                        <tr><td><strong>GEMEINSCHAFTSSCHULE GOLDBERG</strong></td><td align="right">EINRICHTUNGSHILFE</td></tr>
                    </table>
                    <h3 style="margin-top: 5mm; font-weight: 800; font-size: 14pt;">Einrichtung von Threema Work:</h3>
                    <ol style="margin-left: 20px; margin-top: 5mm; line-height: 1.6;">
                        <li>App öffnen und mit den Daten von Seite 1 anmelden.</li>
                        <li>Persönliche <strong>Threema ID</strong> erstellen.</li>
                        <li><strong>Threema Safe</strong> in den Einstellungen aktivieren und Passwort notieren.</li>
                    </ol>
                    <div class="safe-box">
                        <p style="font-weight: 800; text-decoration: underline; margin-bottom: 4mm;">WICHTIGE NOTIZEN:</p>
                        Deine Threema ID:<br><div class="input-line"></div><br>
                        Threema Safe Passwort:<br><div class="input-line"></div>
                    </div>
                    <div style="margin-top: 8mm; padding: 10px; border: 1.5px dashed black; font-size: 9.5pt;">
                        <strong>Hinweis:</strong> Bewahre diesen Zettel sicher auf. Ohne deine ID und das Safe-Passwort kann dein Account bei Geräteverlust nicht wiederhergestellt werden!
                    </div>
                    
                    <div style="margin-top: auto; padding-top: 5mm; border-top: 2px solid black; display: flex; align-items: center; gap: 25px;">
                        <canvas id="qr-vid-${s.id}" style="width: 130px; height: 130px; border: 1.5px solid black; padding: 4px;"></canvas>
                        <div style="font-size: 10pt; line-height: 1.4;">
                            <strong style="text-transform: uppercase; font-size: 11pt;">Video-Anleitungen:</strong><br>
                            Scanne diesen Code für Erklärvideos zur Einrichtung und Wiederherstellung auf unserer Webseite.<br>
                            <span style="color: #000; font-weight: 700;">www.gms-goldberg.de/service/threema-work</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function printAll() {
            printArea.innerHTML = "";
            students.forEach(s => printArea.innerHTML += generateLetterHTML(s));
            setTimeout(() => {
                students.forEach(s => {
                    new QRious({ element: document.getElementById('qr-and-' + s.id), value: 'https://play.google.com/store/apps/details?id=ch.threema.app.work', size: 180 });
                    new QRious({ element: document.getElementById('qr-ios-' + s.id), value: 'https://apps.apple.com/de/app/threema-work/id1105927783', size: 180 });
                    new QRious({ element: document.getElementById('qr-vid-' + s.id), value: 'https://www.gms-goldberg.de/index.php/service/threema-work', size: 250 });
                });
                window.print();
            }, 200);
        }

        function printClass(kl) {
            const list = classesMap[kl];
            printArea.innerHTML = "";
            list.forEach(s => printArea.innerHTML += generateLetterHTML(s));
            setTimeout(() => {
                list.forEach(s => {
                    new QRious({ element: document.getElementById('qr-and-' + s.id), value: 'https://play.google.com/store/apps/details?id=ch.threema.app.work', size: 180 });
                    new QRious({ element: document.getElementById('qr-ios-' + s.id), value: 'https://apps.apple.com/de/app/threema-work/id1105927783', size: 180 });
                    new QRious({ element: document.getElementById('qr-vid-' + s.id), value: 'https://www.gms-goldberg.de/index.php/service/threema-work', size: 250 });
                });
                window.print();
            }, 200);
        }

        function removePerson(idx) { students.splice(idx, 1); updateUI(); }

        function downloadCSV(start, end) {
            let csv = "\uFEFFBenutzername,Passwort,Vorname,Nachname,Mitarbeiternummer,Berufsbezeichnung,Abteilung,E-Mail für App-Aktivierungslink,Tags\n";
            students.slice(start, end).forEach(s => {
                const isT = s.type === 'teacher';
                csv += `"${s.user}","${s.pass}","${s.vn}","${s.nn}","","${isT?'Lehrkraft':'Lernende'}","${isT?'':s.kl}","","${isT?'Lehrende':'SuS'}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `Threema_Import_${appMode}_${start+1}_${end}.csv`; a.click();
        }
    </script>
</body>
</html>
